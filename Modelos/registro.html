<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Registro de Equipo - Muestra Mercadológica</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />

    <link rel="stylesheet" href="../Estilos/styleflujos.css" />
  </head>

  <body>
    <div class="wrapper">
      <div class="contenido admin-container">
        <header class="dashboard-header">
          <h1>Muestra Mercadológica - Registro de Equipo</h1>
          <div class="user-info">
            <span>Inscripción de Equipo</span>
          </div>
        </header>

        <main class="admin-content">
          <div class="container register-container">
            
            <form id="registerForm">
              <fieldset>
                <legend>Información del Equipo</legend>
                <div class="form-group">
                  <label for="team-name">Nombre del Equipo:</label>
                  <input type="text" id="team-name" name="team_name" required />
                </div>
              </fieldset>

              <fieldset>
                <legend>Representante del Equipo</legend>
                <div class="form-group">
                  <label for="rep-name">Nombre Completo:</label>
                  <input
                    type="text"
                    id="rep-name"
                    name="representative_name"
                    required
                  />
                </div>
                <div class="form-group">
                  <label for="rep-id">Matrícula (ID Alumno):</label>
                  <input
                    type="text"
                    id="rep-id"
                    name="representative_id"
                    required
                  />
                </div>
                <div class="form-group">
                  <label for="rep-semester">Semestre:</label>
                  <input
                    type="number"
                    id="rep-semester"
                    name="representative_semester"
                    min="1"
                    required
                  />
                </div>
                <div class="form-group">
                  <label for="rep-email">Correo Institucional (será tu usuario):</label>
                  <input
                    type="email"
                    id="rep-email"
                    name="representative_email"
                    required
                    pattern=".+@alumnos\.uaa\.mx"
                    title="Usa tu correo institucional: ejemplo@alumnos.uaa.mx"
                  />
                </div>
                <div class="form-group">
                  <label for="password">Contraseña:</label>
                  <input
                    type="password"
                    id="password"
                    name="password"
                    required
                  />
                </div>
                <div class="form-group">
                  <label for="confirm-password">Confirmar Contraseña:</label>
                  <input
                    type="password"
                    id="confirm-password"
                    name="confirm_password"
                    required
                  />
                </div>
              </fieldset>

              <fieldset id="members-fieldset">
                <legend>Integrantes Adicionales (Máx. 4)</legend>

                <p class="small-info">
                  El representante ya está incluido. Utiliza el botón de abajo
                  para añadir a los demás miembros (máximo 4).
                </p>

                <div id="member-inputs"></div>

                <button
                  type="button"
                  class="animated-button"
                  id="add-member-btn"
                >
                  <span></span><span></span><span></span><span></span>
                  Añadir Integrante
                </button>
              </fieldset>
              
              <fieldset>
              <button type="submit" class="animated-button">
                <span></span><span></span><span></span><span></span>Registrar Equipo
              </button>
              </fieldset>

              <button type="button" class="animated-button" onclick="location.href='../WhatsAPI/numero.html'">
                <span></span><span></span><span></span><span></span>Registrar Número para Avisos
              </button>
            </form>

            <div id="message" style="margin-top: 15px; text-align: center; font-weight: bold;"></div>

            <div class="user-info">
              <a href="login.html" class="menu-link">
                <span class="hover-underline-animation">¿Ya tienes cuenta? Iniciar sesion</span>
              </a>
            </div>
            <div class="user-info">
              <a href="index.html" class="menu-link">
                <span class="hover-underline-animation">Volver al inicio</span>
              </a>
            </div>
          </div>
        </main>

        <footer
          class="d-flex flex-wrap justify-content-center align-items-center py-3 mt-auto"
          style="background-color: #f0f0f0; width: 100%"
        >
          <div class="d-flex align-items-center justify-content-center">
            <img
              src="../Recursos/UAA-LOGO.png"
              alt="Logo UAA"
              style="height: 80px; margin-right: 15px"
              class="my-1"
            />
            <span class="mb-3 mb-md-0 text-dark">
              &copy; 2025 Muestra Mercadológica UAA
            </span>
          </div>
        </footer>
      </div>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        
        // --- 1. LÓGICA PARA AÑADIR INTEGRANTES ---
        const memberInputsDiv = document.getElementById("member-inputs");
        const addMemberBtn = document.getElementById("add-member-btn");
        let memberCount = 0;
        const MAX_MEMBERS = 4;

        function addMemberInput() {
          if (memberCount >= MAX_MEMBERS) {
            alert(`Has alcanzado el límite de ${MAX_MEMBERS} integrantes adicionales.`);
            addMemberBtn.disabled = true;
            addMemberBtn.textContent = "Límite alcanzado";
            return;
          }

          memberCount++;

          const newMemberDiv = document.createElement("div");
          newMemberDiv.classList.add("member-input-group");
          // Mantenemos el estilo inline para que coincida con el diseño original
          newMemberDiv.innerHTML = `
              <h4 style="margin-top: 5px; font-size: 1.1em; border-bottom: 1px dashed #ddd; padding-bottom: 5px;">Integrante Adicional #${memberCount}</h4>
              <div class="form-group">
                  <label for="member-name-${memberCount}">Nombre Completo:</label>
                  <input type="text" id="member-name-${memberCount}" name="member_name[]" required>
              </div>
              <div class="form-group">
                  <label for="member-id-${memberCount}">Matrícula (ID Alumno):</label>
                  <input type="text" id="member-id-${memberCount}" name="member_id[]" required>
              </div>
          `;
          memberInputsDiv.appendChild(newMemberDiv);

          // Deshabilitar botón visualmente si se llega al límite
          if (memberCount >= MAX_MEMBERS) {
            addMemberBtn.disabled = true;
            addMemberBtn.style.opacity = 0.6;
            // Ocultar las animaciones del botón si es necesario
            const spans = addMemberBtn.querySelectorAll('span');
            spans.forEach(span => span.style.display = 'none');
            addMemberBtn.innerText = "Límite alcanzado";
          }
        }

        if (addMemberBtn) {
            addMemberBtn.addEventListener("click", addMemberInput);
        }

        // --- 2. LÓGICA PARA ENVIAR EL FORMULARIO (API FETCH) ---
        const registerForm = document.getElementById('registerForm');
        const messageDiv = document.getElementById('message');

        if (registerForm) {
            registerForm.addEventListener('submit', function(event) {
                event.preventDefault(); // Evita el submit tradicional

                const formData = new FormData(registerForm);

                // Conexión con el Backend
                fetch('/api/auth/register', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    return response.json().then(data => ({ ok: response.ok, body: data }));
                })
                .then(({ ok, body }) => {
                    if (ok) {
                        messageDiv.style.color = 'green';
                        messageDiv.textContent = body.message;
                        
                        // Guardar sesión automáticamente
                        sessionStorage.setItem('userRole', body.role);
                        sessionStorage.setItem('userName', body.name);
                        sessionStorage.setItem('userId', body.userId);
                        
                        // Redirección
                        setTimeout(() => {
                            window.location.href = '/Modelos/Equipo/dashboard_equipo_multicategoria.html';
                        }, 2000);

                    } else {
                        messageDiv.style.color = 'red';
                        messageDiv.textContent = `Error: ${body.message || 'No se pudo completar el registro.'}`;
                    }
                })
                .catch(error => {
                    console.error('Error al registrar:', error);
                    messageDiv.style.color = 'red';
                    messageDiv.textContent = 'Error de conexión. No se pudo completar el registro.';
                });
            });
        }
      });
    </script>
  </body>
</html>